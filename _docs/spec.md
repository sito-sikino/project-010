# Discord LLM Bot - 要件定義書

## 1. プロジェクト概要

GitHub上のObsidian Vaultからランダムにノートを取得し、Gemini 2.0 Flashがそれらを組み合わせてアイデア自動生成・投稿するDiscordボット。最小限の構成で24時間VPS稼働で運用する。

## 2. 機能要件

### 2.1 アイデア生成・投稿（10分間隔）
- **ランダムノート取得**: GitHub API経由でObsidian Vault特定フォルダ（20_Literature）からランダムに3ノートを取得
- **思考プロセス可視化アイデア生成**: 取得したノート断片をGemini 2.0 Flashに渡して段階的思考プロセス（STEP1-4）を明示させながら創作アイデア（物語の基礎コンセプト案）生成
- **レスポンス分離**: Geminiレスポンスから思考プロセス部分と最終出力部分を堅牢に分離
- **自動投稿**: 最終出力のみをDiscordに投稿（思考プロセスは非表示）
- **詳細ログ記録**: 思考プロセスの詳細をログファイルで永続記録、統計情報も自動計算

## 3. 技術要件

### 3.1 API制限遵守
```
Gemini 2.0 Flash: 200 req/day上限
└── アイデア生成・投稿: 144回/日 (10分間隔で十分な余裕)

GitHub API: 5,000 req/hour上限
└── ランダムノート取得: 144回/日 (十分な余裕)
```

### 3.2 処理フロー（思考プロセス可視化対応）
```
アイデア生成（10分間隔）
GitHub API → 20_Literatureフォルダから3ノート取得 → Gemini段階的生成 → レスポンス分離 → Discord投稿
     ↓              ↓                    ↓              ↓          ↓
  ログ記録      ファイル名記録      思考プロセス記録    最終出力分離   投稿結果記録
                                  (STEP1-4詳細)      (ログライン・世界観・キャラクター)
```

### 3.3 アーキテクチャパターン
**思考プロセス可視化対応スケジューラー**

```
Main Scheduler (10min間隔)
└── Content Generation Function
    ├── GitHub API: 20_Literatureフォルダから3ノート取得
    ├── Gemini 2.0 Flash: 段階的思考プロセス生成（STEP1-4）
    ├── Response Separation: 思考プロセス ↔ 最終出力分離
    ├── Discord API: 最終出力のみ投稿
    └── Enhanced Log System: 思考プロセス詳細記録 + 統計情報
```

## 4. 非機能要件

### 4.1 稼働要件
- **稼働環境**: VPS上での24時間常時稼働
- **可用性**: Fail-Fast原則による即時障害検知・停止
- **回復性**: エラー発生時の自動再起動

### 4.2 性能要件
- **処理能力**: API制限内での最大スループット
- **応答速度**: 投稿処理の安定実行
- **メモリ使用**: 最小限（データ永続化なし）

### 4.3 セキュリティ要件
- **認証情報**: `.env`による環境変数管理
- **API Key**: GitHub、Gemini、Discord APIキー管理
- **ログ管理**: 機密情報の非記録、構造化ログのファイル出力（logs/discord_bot.log）

## 5. 開発制約

### 5.1 設定管理原則
- **一元管理**: `settings.py`での意味的設定値管理
- **環境分離**: `.env`での機密情報・環境依存値管理
- **ハードコード禁止**: 具体値の直接記述禁止

### 5.2 開発手法
- **TDD採用**: Red→Green→Refactor→Commitサイクル
- **Fail-Fast**: 異常時の即時停止、フォールバック禁止
- **最小実装**: 要求機能のみの実装

### 5.3 品質基準
- **コード品質**: `black`, `flake8`, `mypy`準拠
- **テスト**: `pytest`による単体・統合テスト
- **文書化**: 日本語コメントによる意図説明

## 6. 技術スタック

- **言語**: Python 3.9+
- **フレームワーク**: discord.py
- **API**: GitHub API, Google Gemini 2.0 Flash, Discord API
- **稼働環境**: VPS (Linux)
- **スケジューラー**: APScheduler または asyncio

## 7. 開発フェーズ

```
Phase 1: EXPLORE（調査）
├── GitHub API仕様調査
├── Gemini 2.0 Flash API仕様調査
└── Discord Bot実装方法調査

Phase 2: PLAN（計画）
├── タスク分割（todo.md）
├── TDDサイクル設計
└── 設定値定義

Phase 3: IMPLEMENT（実装）
├── Red: 失敗テスト作成
├── Green: 最小実装
├── Refactor: 品質改善
└── Commit: 履歴化

Phase 4: VERIFY（統合検証）
├── 統合テスト実行
├── 品質基準確認
└── 成果物固定
```